#!/usr/bin/env bash

OKURA_BIN="$HOME/.okura/bin"
OKURA_ENVS="$HOME/.okura/envs"
RUBY_PATH=$(realpath $OKURA_BIN/ruby)
ENV_PATH=${RUBY_PATH#$OKURA_ENVS/}
ACTIVE_ENV=${ENV_PATH%%/*}

while : ; do
  case $1 in
    -t|--test)
      okura_test=test
      shift
      ;;
    activate)
      if [ "$2" ] ; then
        if [ -d "$OKURA_ENVS/$2/bin" ] ; then
          if [[ $okura_test == test ]]; then
            echo "Testing environment activation:"
          else
            echo "Activating environment '$2'"
          fi
          for file in "$OKURA_ENVS/$2/bin/"*; do
            if [[ $okura_test == test ]]; then
              echo "> link ${file} => $OKURA_BIN/${file##*/}"
            else
              ln -sfn "${file}" "$OKURA_BIN/${file##*/}"
            fi
          done
        else
          echo "ERROR: '$2' is not an environment name"
        fi
      else
        echo "ERROR: 'activate' requires environment name"
        exit 1
      fi
      break
      ;;
    list)
      for dir in "$OKURA_ENVS/"*; do
        if [[ ${dir##*/} == $ACTIVE_ENV ]]; then
          echo -e "\033[0;31m> ${dir##*/}\033[0m"
        else
          echo "  ${dir##*/}"
        fi
      done
      break
      ;;
    env)
      echo ${ACTIVE_ENV}
      break
      ;;
    *)
      echo "ERROR: use 'okura [--test] activate <ENV>' to activate environment"
      exit 1
      ;;
  esac
done
